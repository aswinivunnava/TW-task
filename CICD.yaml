trigger:
- master

variables:
  azureSubscription: 'AzureSubscription'
  acrName: 'ACRName'
  helmChartPath: 'path/to/your/helm/chart'
  namespace: 'tw-namespace'
  kubernetesServiceConnection: 'KubernetesServiceConnection'

stages:
- stage: Deploy
  displayName: Deploy Helm Chart
  jobs:
  - job: Deploy
    displayName: Deploy to Kubernetes
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Login to Azure'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: 'az acr login --name $(acrName)'
    
    - task: AzureCLI@2
      displayName: 'Pull latest image digest from ACR'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          imageDigest=$(az acr repository show-manifests --name $(acrName) --repository your-repository-name --query "[0].digest" -o tsv)
          echo "Latest image digest: $imageDigest"
    
    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: 'latest'
    
    - task: HelmDeploy@0
      displayName: 'Deploy Helm chart'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscription: $(azureSubscription)
        azureResourceGroup: 'YourResourceGroup'
        kubernetesCluster: 'YourAKSCluster'
        namespace: $(namespace)
        command: 'upgrade'
        chartType: 'FilePath'
        chartPath: $(helmChartPath)
        releaseName: 'your-release-name'
        overrideValues: |
          image.repository=your-image-repository
          image.tag=$(imageDigest)

